(this.webpackJsonpbbit8=this.webpackJsonpbbit8||[]).push([[0],{10:function(t,e,o){t.exports=o(17)},16:function(t,e,o){},17:function(t,e,o){"use strict";o.r(e);var n=o(4),i=o.n(n),s=o(0),a=o(1),r=o(6),c=o(5),u=o(7),h=o(2),l=o.n(h),b=o(9),f=o.n(b),d=o(3),k=o.n(d),v=new(function(){function t(){Object(s.a)(this,t),this.channels={}}return Object(a.a)(t,[{key:"addChannel",value:function(t,e){this.channels[t]=e}},{key:"getChannel",value:function(t){return this.channels[t]}},{key:"removeChannel",value:function(t){delete this.channels[t]}}]),t}()),y=1,p=2,R=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:p;Object(s.a)(this,t),this.message=[],this.takers=[],this.mode=e}return Object(a.a)(t,[{key:"put",value:function(t){if(this.takers.length>0)if(this.mode===y){var e=this.takers.slice();this.takers=[];var o=!0,n=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(o=(s=a.next()).done);o=!0){var r=s.value;try{r(t)}catch(c){console.log("[Channel] put error: ",t,c)}}}catch(u){n=!0,i=u}finally{try{o||null==a.return||a.return()}finally{if(n)throw i}}}else this.takers.shift()(t);else this.message.push(t)}},{key:"take",value:function(){var t=this;return new Promise((function(e){t.message.length>0?e(t.message.shift()):t.takers.push(e)}))}},{key:"hasTaker",value:function(){return this.takers.length>0}}]),t}(),m=new(function(){function t(){Object(s.a)(this,t),this.entities={}}return Object(a.a)(t,[{key:"addEntity",value:function(t,e){this.entities[t]=e}},{key:"getEntity",value:function(t){return this.entities[t]}},{key:"removeEntity",value:function(t){delete this.entities[t]}}]),t}()),g=function(t){function e(t){var o;return Object(s.a)(this,e),(o=Object(r.a)(this,Object(c.a)(e).call(this,t))).mounted=!1,t.entity&&(o.entity=t.entity,o.id=o.entity.id,m.addEntity(o.id,o.entity),o.state=o.entity.getState(),o.channel=new R,v.addChannel(o.id,o.channel)),o}return Object(u.a)(e,t),Object(a.a)(e,[{key:"componentDidMount",value:function(){this.mounted=!0,this.loop()}},{key:"componentWillUnmount",value:function(){this.mounted=!1}},{key:"loop",value:function(){var t;return i.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.mounted){e.next=7;break}return e.next=3,i.a.awrap(this.channel.take());case 3:t=e.sent,this.remote(t),e.next=0;break;case 7:case"end":return e.stop()}}),null,this)}},{key:"remote",value:function(t){}}]),e}(h.Component),C=function(){function t(e){Object(s.a)(this,t),this.id=e,this.state={canCross:!0,isRobot:!1}}return Object(a.a)(t,[{key:"getState",value:function(){return this.state}},{key:"setCross",value:function(t){this.state.canCross=t}},{key:"canCross",value:function(){return this.state.canCross}},{key:"setRobot",value:function(){this.state.isRobot=!0}}]),t}(),S=0,j=1,I=2,L=3,O=4,w=0,M=1,x=2,B=3,E=4,G=function(){function t(e){Object(s.a)(this,t),this.id=e,this.state={refresh:!1},this.difficulty=.2,this.blocks=[],this.blockIdMap={},this.blockLocGrid=[[],[],[],[]],this.blockIdLocMap={},this.canCrossBlocks=[],this.robotId=0,this.robotState=S,this.initBlocks(),this.initRobot()}return Object(a.a)(t,[{key:"getState",value:function(){return this.state}},{key:"getBlocks",value:function(){return this.blocks}},{key:"getRobotId",value:function(){return this.robotId}},{key:"getRandomRobotId",value:function(){return this.canCrossBlocks[Math.floor(Math.random()*this.canCrossBlocks.length)].id}},{key:"setRobotId",value:function(t){this.robotId=t,this.robotState=S}},{key:"initBlocks",value:function(){for(var t=[],e=[],o=0;o<16;++o){var n="block:".concat(o+1),i=new C(n),s=Math.random()>=this.difficulty;s&&e.push(i),i.setCross(s),t.push(i);var a=o%4,r=Math.floor(o/4);this.blockLocGrid[a][r]=n,this.blockIdLocMap[n]=[a,r],this.blockIdMap[n]=i,this.canCrossBlocks=e}this.blocks=t}},{key:"initRobot",value:function(){var t=this.canCrossBlocks[Math.floor(Math.random()*this.canCrossBlocks.length)];this.robotId=t.id,t.setRobot()}},{key:"updateRobotLoc",value:function(t,e){var o=t.slice();switch(e){case j:return o[0]--,o;case I:return o[0]++,o;case L:return o[1]--,o;case O:return o[1]++,o}}},{key:"getRobotSurr",value:function(t){var e="",o=this.updateRobotLoc(t,j),n=this.blockLocGrid[o[0]],i=n?n[o[1]]:0;return i&&this.blockIdMap[i].canCross()?e+="x":e+="U",o=this.updateRobotLoc(t,I),(i=(n=this.blockLocGrid[o[0]])?n[o[1]]:0)&&this.blockIdMap[i].canCross()?e+="x":e+="D",o=this.updateRobotLoc(t,L),(i=(n=this.blockLocGrid[o[0]])?n[o[1]]:0)&&this.blockIdMap[i].canCross()?e+="x":e+="L",o=this.updateRobotLoc(t,O),(i=(n=this.blockLocGrid[o[0]])?n[o[1]]:0)&&this.blockIdMap[i].canCross()?e+="x":e+="R",e}},{key:"getRobotActionByRules",value:function(t){var e=[],o=!0,n=!1,i=void 0;try{for(var s,a=t[Symbol.iterator]();!(o=(s=a.next()).done);o=!0){var r=s.value;r.state===this.robotState&&e.push(r)}}catch(x){n=!0,i=x}finally{try{o||null==a.return||a.return()}finally{if(n)throw i}}console.log("[getRobotActionByRules] effectiveRules:%j",e);for(var c=this.blockIdLocMap[this.robotId],u=this.getRobotSurr(c),h=0,l=e;h<l.length;h++){var b=l[h];if(b.match(u))switch(this.robotState=b.newState,b.action){case"U":var f=this.updateRobotLoc(c,j),d=this.blockLocGrid[f[0]],k=d?d[f[1]]:0;if(k)if(this.blockIdMap[k].canCross())return{action:M,loc:f,id:k};case"D":var v=this.updateRobotLoc(c,I),y=this.blockLocGrid[v[0]],p=y?y[v[1]]:0;if(p)if(this.blockIdMap[p].canCross())return{action:M,loc:v,id:p};case"L":var R=this.updateRobotLoc(c,L),m=this.blockLocGrid[R[0]],g=m?m[R[1]]:0;if(g)if(this.blockIdMap[g].canCross())return{action:M,loc:R,id:g};case"R":var C=this.updateRobotLoc(c,O),S=this.blockLocGrid[C[0]],w=S?S[C[1]]:0;if(w)if(this.blockIdMap[w].canCross())return{action:M,loc:C,id:w}}}}},{key:"getRobotAction",value:function(){switch(this.robotState){case S:case j:case I:case L:case O:var t=this.blockIdLocMap[this.robotId],e=this.updateRobotLoc(t,j),o=this.blockLocGrid[e[0]],n=o?o[e[1]]:0;if(n)if(this.blockIdMap[n].canCross())return{action:M,loc:e,id:n};if(e=this.updateRobotLoc(t,I),n=(o=this.blockLocGrid[e[0]])?o[e[1]]:0)if(this.blockIdMap[n].canCross())return{action:x,loc:e,id:n};if(e=this.updateRobotLoc(t,L),n=(o=this.blockLocGrid[e[0]])?o[e[1]]:0)if(this.blockIdMap[n].canCross())return{action:B,loc:e,id:n};if(e=this.updateRobotLoc(t,O),n=(o=this.blockLocGrid[e[0]])?o[e[1]]:0)if(this.blockIdMap[n].canCross())return{action:E,loc:e,id:n}}return{action:w,loc:this.blockIdLocMap[this.robotId],id:this.robotId}}}]),t}(),P=function(){function t(e){Object(s.a)(this,t),this.id=e,this.state={value:"# \u8bf4\u660e\n# \u89c4\u5219\u683c\u5f0f: \n#\t\u72b6\u6001 \u5468\u56f4\u73af\u5883 -> \u52a8\u4f5c \u65b0\u72b6\u6001\n# \u72b6\u6001\u96c6\u5408: \n#\t0-\u9759\u6b62 1-\u5411\u4e0a 2-\u5411\u4e0b 3-\u5411\u5de6 4-\u5411\u53f3\n# \u73af\u5883\u8868\u793a:\n#\t*-\u4efb\u610f x-\u53ef\u901a\u884c U/D/L/R-\u4e0d\u53ef\u901a\u884c\n#\t\u6bd4\u5982,\n#\t1)UDLR \u8868\u793a\u4e0a\u4e0b\u5de6\u53f3\u90fd\u4e0d\u53ef\u901a\u884c\n#\t2)x*** \u8868\u793a\u673a\u5668\u4eba\u4e0a\u65b9\u53ef\u901a\u884c\n#\t3)U*** \u8868\u793a\u673a\u5668\u4eba\u4e0a\u65b9\u4e0d\u53ef\u901a\u884c\n# \u52a8\u4f5c\u96c6\u5408: \n#\t0-\u505c\u6b62 1-\u5411\u4e0a 2-\u5411\u4e0b 3-\u5411\u5de6 4-\u5411\u53f3\n# \n# \u673a\u5668\u4eba\u521d\u59cb\u72b6\u6001\u4e3a0\n# \n0 x*** -> U 1\n0 U*** -> D 1\n1 x*** -> U 1\n1 U*** -> D 2\n2 *x** -> D 2\n",check:""}}return Object(a.a)(t,[{key:"getState",value:function(){return this.state}}]),t}(),U=function(){function t(e){Object(s.a)(this,t);var o=e.split(" ");this.state=o[0]-0,this.surr=o[1],this.action=o[3],this.newState=o[4]-0}return Object(a.a)(t,[{key:"match",value:function(t){for(var e=0;e<this.surr.length;++e){var o=t[e],n=this.surr[e];if("*"!==n&&n!==o)return!1}return!0}}]),t}();o(16);function D(t){return new Promise((function(e){return setTimeout(e,t)}))}var N=function(t){function e(t){return Object(s.a)(this,e),Object(r.a)(this,Object(c.a)(e).call(this,t))}return Object(u.a)(e,t),Object(a.a)(e,[{key:"getStyle",value:function(){return this.state.canCross?"block":"barrier"}},{key:"remote",value:function(t){switch(console.log("[BlockSystem] id:".concat(this.id,", msg:").concat(JSON.stringify(t))),t.cmd){case k.a.CanCross:this.setState((function(e){return{canCross:t.canCross}}));break;case k.a.SetRobot:this.setState((function(t){return{isRobot:!0}}));break;case k.a.ClearRobot:this.setState((function(t){return{isRobot:!1}}))}}},{key:"getRobotView",value:function(){if(this.state.isRobot)return l.a.createElement("div",{className:"robot"})}},{key:"render",value:function(){return l.a.createElement("div",{className:this.getStyle()},this.entity.id,this.getRobotView())}}]),e}(g),A=function(t){function e(t){var o;return Object(s.a)(this,e),(o=Object(r.a)(this,Object(c.a)(e).call(this,t))).blockSystems=[],o.initBlockSystem(),o.robotPath=!1,o}return Object(u.a)(e,t),Object(a.a)(e,[{key:"initBlockSystem",value:function(){for(var t=[],e=this.entity.getBlocks(),o=0;o<e.length;++o)t.push(l.a.createElement(N,{key:o+1,entity:e[o]}));this.blockSystems=t}},{key:"remote",value:function(t){console.log("[GridSystem] id:".concat(this.id,", msg:").concat(JSON.stringify(t))),t.cmd===k.a.Refresh?this.setState((function(t){return{refresh:!t.refresh}})):t.cmd===k.a.PathRobot&&(this.robotPath=!0,this.pathRobot(t.rules))}},{key:"refresh",value:function(){this.robotPath=!1,this.entity.initBlocks();for(var t=this.entity.getBlocks(),e=0;e<t.length;++e){var o=t[e];v.getChannel(o.id).put({cmd:k.a.CanCross,canCross:o.canCross()})}this.setRobot()}},{key:"pathRobot",value:function(t){var e,o,n,s,a,r,c,u;return i.a.async((function(h){for(;;)switch(h.prev=h.next){case 0:if(!this.robotPath){h.next=30;break}for(e=[],o=!0,n=!1,s=void 0,h.prev=5,a=t[Symbol.iterator]();!(o=(r=a.next()).done);o=!0)c=r.value,e.push(new U(c));h.next=13;break;case 9:h.prev=9,h.t0=h.catch(5),n=!0,s=h.t0;case 13:h.prev=13,h.prev=14,o||null==a.return||a.return();case 16:if(h.prev=16,!n){h.next=19;break}throw s;case 19:return h.finish(16);case 20:return h.finish(13);case 21:if(u=this.entity.getRobotActionByRules(e),console.log("[pathRobot] robotPath:".concat(this.robotPath,", action:%j"),u),u){h.next=25;break}return h.abrupt("break",30);case 25:return this.setRobot(u.id),h.next=28,i.a.awrap(D(850));case 28:h.next=0;break;case 30:case"end":return h.stop()}}),null,this,[[5,9,13,21],[14,,16,20]])}},{key:"setRobot",value:function(t){var e=this.entity.getRobotId();e&&v.getChannel(e).put({cmd:k.a.ClearRobot}),e=t||this.entity.getRandomRobotId(),this.entity.setRobotId(e),console.log("getRobot ",e),v.getChannel(e).put({cmd:k.a.SetRobot})}},{key:"render",value:function(){return this.state.refresh&&(this.refresh(),this.channel.put({cmd:k.a.Refresh})),l.a.createElement("div",{className:"grid"},this.blockSystems)}}]),e}(g),J=function(t){function e(t){var o;Object(s.a)(this,e);(o=Object(r.a)(this,Object(c.a)(e).call(this,t))).grid=new G("grid:1");return o.ruleInput=new P("ruleInput:1"),o}return Object(u.a)(e,t),Object(a.a)(e,[{key:"render",value:function(){return l.a.createElement("div",{className:"room"},l.a.createElement(A,{entity:this.grid}),l.a.createElement("div",{id:"refresh"},l.a.createElement("button",{onClick:function(){}},"REFRESH")))}}]),e}(h.Component);f.a.render(l.a.createElement(J,null),document.getElementById("root"))},3:function(t,e){t.exports={CanCross:"CanCross",SetRobot:"SetRobot",ClearRobot:"ClearRobot",Refresh:"Refresh",PathRobot:"PathRobot",SubmitRule:"SubmitRule"}}},[[10,1,2]]]);