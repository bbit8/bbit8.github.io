(this.webpackJsonpbbit8=this.webpackJsonpbbit8||[]).push([[0],{10:function(t,e,n){t.exports=n(17)},16:function(t,e,n){},17:function(t,e,n){"use strict";n.r(e);var o=n(7),i=n.n(o),s=n(1),a=n(2),r=n(5),c=n(4),u=n(6),l=n(0),h=n.n(l),b=n(9),f=n.n(b),d=n(3),k=n.n(d),v=new(function(){function t(){Object(s.a)(this,t),this.channels={}}return Object(a.a)(t,[{key:"addChannel",value:function(t,e){this.channels[t]=e}},{key:"getChannel",value:function(t){return this.channels[t]}},{key:"removeChannel",value:function(t){delete this.channels[t]}}]),t}()),y=1,m=2,p=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:m;Object(s.a)(this,t),this.message=[],this.takers=[],this.mode=e}return Object(a.a)(t,[{key:"put",value:function(t){if(this.takers.length>0)if(this.mode===y){var e=this.takers.slice();this.takers=[];var n=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var r=s.value;try{r(t)}catch(c){console.log("[Channel] put error: ",t,c)}}}catch(u){o=!0,i=u}finally{try{n||null==a.return||a.return()}finally{if(o)throw i}}}else this.takers.shift()(t);else this.message.push(t)}},{key:"take",value:function(){var t=this;return new Promise((function(e){t.message.length>0?e(t.message.shift()):t.takers.push(e)}))}},{key:"hasTaker",value:function(){return this.takers.length>0}}]),t}(),R=new(function(){function t(){Object(s.a)(this,t),this.entities={}}return Object(a.a)(t,[{key:"addEntity",value:function(t,e){this.entities[t]=e}},{key:"getEntity",value:function(t){return this.entities[t]}},{key:"removeEntity",value:function(t){delete this.entities[t]}}]),t}()),g=function(t){function e(t){var n;return Object(s.a)(this,e),(n=Object(r.a)(this,Object(c.a)(e).call(this,t))).mounted=!1,t.entity&&(n.entity=t.entity,n.id=n.entity.id,R.addEntity(n.id,n.entity),n.state=n.entity.getState(),n.channel=new p,v.addChannel(n.id,n.channel)),n}return Object(u.a)(e,t),Object(a.a)(e,[{key:"componentDidMount",value:function(){this.mounted=!0,this.loop()}},{key:"componentWillUnmount",value:function(){this.mounted=!1}},{key:"loop",value:function(){var t;return i.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.mounted){e.next=7;break}return e.next=3,i.a.awrap(this.channel.take());case 3:t=e.sent,this.remote(t),e.next=0;break;case 7:case"end":return e.stop()}}),null,this)}},{key:"remote",value:function(t){}}]),e}(l.Component),C=function(){function t(e){Object(s.a)(this,t),this.id=e,this.state={canCross:!0,isRobot:!1}}return Object(a.a)(t,[{key:"getState",value:function(){return this.state}},{key:"setCross",value:function(t){this.state.canCross=t}},{key:"canCross",value:function(){return this.state.canCross}},{key:"setRobot",value:function(){this.state.isRobot=!0}}]),t}(),S=0,O=1,j=2,I=3,L=4,x=0,w=1,M=2,E=3,B=4,G=function(){function t(e){Object(s.a)(this,t),this.id=e,this.state={refresh:!1},this.difficulty=.2,this.blocks=[],this.blockIdMap={},this.blockLocGrid=[[],[],[],[]],this.blockIdLocMap={},this.canCrossBlocks=[],this.robotId=0,this.robotState=S,this.initBlocks(),this.initRobot()}return Object(a.a)(t,[{key:"getState",value:function(){return this.state}},{key:"getBlocks",value:function(){return this.blocks}},{key:"getRobotId",value:function(){return this.robotId}},{key:"getRandomRobotId",value:function(){return this.canCrossBlocks[Math.floor(Math.random()*this.canCrossBlocks.length)].id}},{key:"setRobotId",value:function(t){this.robotId=t,this.robotState=S}},{key:"initBlocks",value:function(){for(var t=[],e=[],n=0;n<16;++n){var o="block:".concat(n+1),i=new C(o),s=Math.random()>=this.difficulty;s&&e.push(i),i.setCross(s),t.push(i);var a=n%4,r=Math.floor(n/4);this.blockLocGrid[a][r]=o,this.blockIdLocMap[o]=[a,r],this.blockIdMap[o]=i,this.canCrossBlocks=e}this.blocks=t}},{key:"initRobot",value:function(){var t=this.canCrossBlocks[Math.floor(Math.random()*this.canCrossBlocks.length)];this.robotId=t.id,t.setRobot()}},{key:"updateRobotLoc",value:function(t,e){var n=t.slice();switch(e){case O:return n[0]--,n;case j:return n[0]++,n;case I:return n[1]--,n;case L:return n[1]++,n}}},{key:"getRobotSurr",value:function(t){var e="",n=this.updateRobotLoc(t,O),o=this.blockLocGrid[n[0]],i=o?o[n[1]]:0;return i&&this.blockIdMap[i].canCross()?e+="x":e+="U",n=this.updateRobotLoc(t,j),(i=(o=this.blockLocGrid[n[0]])?o[n[1]]:0)&&this.blockIdMap[i].canCross()?e+="x":e+="D",n=this.updateRobotLoc(t,I),(i=(o=this.blockLocGrid[n[0]])?o[n[1]]:0)&&this.blockIdMap[i].canCross()?e+="x":e+="L",n=this.updateRobotLoc(t,L),(i=(o=this.blockLocGrid[n[0]])?o[n[1]]:0)&&this.blockIdMap[i].canCross()?e+="x":e+="R",e}},{key:"getRobotActionByRules",value:function(t){var e=[],n=!0,o=!1,i=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var r=s.value;r.state===this.robotState&&e.push(r)}}catch(M){o=!0,i=M}finally{try{n||null==a.return||a.return()}finally{if(o)throw i}}console.log("[getRobotActionByRules] effectiveRules:%j",e);for(var c=this.blockIdLocMap[this.robotId],u=this.getRobotSurr(c),l=0,h=e;l<h.length;l++){var b=h[l];if(b.match(u))switch(this.robotState=b.newState,b.action){case"U":var f=this.updateRobotLoc(c,O),d=this.blockLocGrid[f[0]],k=d?d[f[1]]:0;if(k)if(this.blockIdMap[k].canCross())return{action:w,loc:f,id:k};case"D":var v=this.updateRobotLoc(c,j),y=this.blockLocGrid[v[0]],m=y?y[v[1]]:0;if(m)if(this.blockIdMap[m].canCross())return{action:w,loc:v,id:m};case"L":var p=this.updateRobotLoc(c,I),R=this.blockLocGrid[p[0]],g=R?R[p[1]]:0;if(g)if(this.blockIdMap[g].canCross())return{action:w,loc:p,id:g};case"R":var C=this.updateRobotLoc(c,L),S=this.blockLocGrid[C[0]],x=S?S[C[1]]:0;if(x)if(this.blockIdMap[x].canCross())return{action:w,loc:C,id:x}}}}},{key:"getRobotAction",value:function(){switch(this.robotState){case S:case O:case j:case I:case L:var t=this.blockIdLocMap[this.robotId],e=this.updateRobotLoc(t,O),n=this.blockLocGrid[e[0]],o=n?n[e[1]]:0;if(o)if(this.blockIdMap[o].canCross())return{action:w,loc:e,id:o};if(e=this.updateRobotLoc(t,j),o=(n=this.blockLocGrid[e[0]])?n[e[1]]:0)if(this.blockIdMap[o].canCross())return{action:M,loc:e,id:o};if(e=this.updateRobotLoc(t,I),o=(n=this.blockLocGrid[e[0]])?n[e[1]]:0)if(this.blockIdMap[o].canCross())return{action:E,loc:e,id:o};if(e=this.updateRobotLoc(t,L),o=(n=this.blockLocGrid[e[0]])?n[e[1]]:0)if(this.blockIdMap[o].canCross())return{action:B,loc:e,id:o}}return{action:x,loc:this.blockIdLocMap[this.robotId],id:this.robotId}}}]),t}(),U=function(){function t(e){Object(s.a)(this,t),this.id=e,this.state={value:"# \u8bf4\u660e\n# \u89c4\u5219\u683c\u5f0f: \n#\t\u72b6\u6001 \u5468\u56f4\u73af\u5883 -> \u52a8\u4f5c \u65b0\u72b6\u6001\n#\t0 x*** -> U 1\n# \u72b6\u6001\u96c6\u5408: \n#\t0-\u9759\u6b62 1-\u5411\u4e0a 2-\u5411\u4e0b 3-\u5411\u5de6 4-\u5411\u53f3\n# \u73af\u5883\u8868\u793a:\n#\t*-\u4efb\u610f x-\u53ef\u901a\u884c U/D/L/R-\u4e0d\u53ef\u901a\u884c\n#\t\u6bd4\u5982,\n#\t1)UDLR \u8868\u793a\u4e0a\u4e0b\u5de6\u53f3\u90fd\u4e0d\u53ef\u901a\u884c\n#\t2)x*** \u8868\u793a\u673a\u5668\u4eba\u4e0a\u65b9\u53ef\u901a\u884c\n#\t3)U*** \u8868\u793a\u673a\u5668\u4eba\u4e0a\u65b9\u4e0d\u53ef\u901a\u884c\n# \u52a8\u4f5c\u96c6\u5408: \n#\t0-\u505c\u6b62 1-\u5411\u4e0a 2-\u5411\u4e0b 3-\u5411\u5de6 4-\u5411\u53f3\n# \n# \u673a\u5668\u4eba\u521d\u59cb\u72b6\u6001\u4e3a0\n# \n0 x*** -> U 1\n0 U*** -> D 1\n1 x*** -> U 1\n1 U*** -> D 2\n2 *x** -> D 2\n",check:""}}return Object(a.a)(t,[{key:"getState",value:function(){return this.state}}]),t}(),N=function(){function t(e){Object(s.a)(this,t);var n=e.split(" ");this.state=n[0]-0,this.surr=n[1],this.action=n[3],this.newState=n[4]-0}return Object(a.a)(t,[{key:"match",value:function(t){for(var e=0;e<this.surr.length;++e){var n=t[e],o=this.surr[e];if("*"!==o&&o!==n)return!1}return!0}}]),t}();n(16);function P(t){return new Promise((function(e){return setTimeout(e,t)}))}var D=function(t){function e(t){return Object(s.a)(this,e),Object(r.a)(this,Object(c.a)(e).call(this,t))}return Object(u.a)(e,t),Object(a.a)(e,[{key:"getStyle",value:function(){return this.state.canCross?"block":"barrier"}},{key:"remote",value:function(t){switch(console.log("[BlockSystem] id:".concat(this.id,", msg:").concat(JSON.stringify(t))),t.cmd){case k.a.CanCross:this.setState((function(e){return{canCross:t.canCross}}));break;case k.a.SetRobot:this.setState((function(t){return{isRobot:!0}}));break;case k.a.ClearRobot:this.setState((function(t){return{isRobot:!1}}))}}},{key:"getRobotView",value:function(){if(this.state.isRobot)return h.a.createElement("div",{className:"robot"})}},{key:"render",value:function(){return h.a.createElement("div",{className:this.getStyle()},this.entity.id,this.getRobotView())}}]),e}(g),J=function(t){function e(t){var n;return Object(s.a)(this,e),(n=Object(r.a)(this,Object(c.a)(e).call(this,t))).blockSystems=[],n.initBlockSystem(),n.robotPath=!1,n}return Object(u.a)(e,t),Object(a.a)(e,[{key:"initBlockSystem",value:function(){for(var t=[],e=this.entity.getBlocks(),n=0;n<e.length;++n)t.push(h.a.createElement(D,{key:n+1,entity:e[n]}));this.blockSystems=t}},{key:"remote",value:function(t){console.log("[GridSystem] id:".concat(this.id,", msg:").concat(JSON.stringify(t))),t.cmd===k.a.Refresh?this.setState((function(t){return{refresh:!t.refresh}})):t.cmd===k.a.PathRobot&&(this.robotPath=!0,this.pathRobot(t.rules))}},{key:"refresh",value:function(){this.robotPath=!1,this.entity.initBlocks();for(var t=this.entity.getBlocks(),e=0;e<t.length;++e){var n=t[e];v.getChannel(n.id).put({cmd:k.a.CanCross,canCross:n.canCross()})}this.setRobot()}},{key:"pathRobot",value:function(t){var e,n,o,s,a,r,c,u;return i.a.async((function(l){for(;;)switch(l.prev=l.next){case 0:if(!this.robotPath){l.next=30;break}for(e=[],n=!0,o=!1,s=void 0,l.prev=5,a=t[Symbol.iterator]();!(n=(r=a.next()).done);n=!0)c=r.value,e.push(new N(c));l.next=13;break;case 9:l.prev=9,l.t0=l.catch(5),o=!0,s=l.t0;case 13:l.prev=13,l.prev=14,n||null==a.return||a.return();case 16:if(l.prev=16,!o){l.next=19;break}throw s;case 19:return l.finish(16);case 20:return l.finish(13);case 21:if(u=this.entity.getRobotActionByRules(e),console.log("[pathRobot] robotPath:".concat(this.robotPath,", action:%j"),u),u){l.next=25;break}return l.abrupt("break",30);case 25:return this.setRobot(u.id),l.next=28,i.a.awrap(P(850));case 28:l.next=0;break;case 30:case"end":return l.stop()}}),null,this,[[5,9,13,21],[14,,16,20]])}},{key:"setRobot",value:function(t){var e=this.entity.getRobotId();e&&v.getChannel(e).put({cmd:k.a.ClearRobot}),e=t||this.entity.getRandomRobotId(),this.entity.setRobotId(e),console.log("getRobot ",e),v.getChannel(e).put({cmd:k.a.SetRobot})}},{key:"render",value:function(){return this.state.refresh&&(this.refresh(),this.channel.put({cmd:k.a.Refresh})),h.a.createElement("div",{className:"grid"},this.blockSystems)}}]),e}(g),A=function(t){function e(t){return Object(s.a)(this,e),Object(r.a)(this,Object(c.a)(e).call(this,t))}return Object(u.a)(e,t),Object(a.a)(e,[{key:"rulesCheck",value:function(t){var e=[],n=!0,o=!1,i=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var r=s.value,c=r.split(" ");if(console.log("[rulesCheck]",c),c.length&&c[0].length&&"#"!==c[0][0]){if(5!==c.length)return!1;var u=c[0]-0,l=c[1],h=c[3],b=c[4]-0;if(isNaN(u)||u<0||u>4)return console.log("[rulesCheck]  state error",u),!1;if(isNaN(b)||b<0||b>4)return console.log("[rulesCheck]  newState error",b),!1;if("U"!==h&&"D"!==h&&"L"!==h&&"R"!==h)return console.log("[rulesCheck]  action error",h),!1;if(4!==l.length||"x"!==l[0]&&"*"!==l[0]&&"U"!==l[0]||"x"!==l[1]&&"*"!==l[1]&&"D"!==l[1]||"x"!==l[2]&&"*"!==l[2]&&"L"!==l[2]||"x"!==l[3]&&"*"!==l[3]&&"R"!==l[3])return console.log("[rulesCheck]  surr error",l),!1;e.push(r)}}}catch(f){o=!0,i=f}finally{try{n||null==a.return||a.return()}finally{if(o)throw i}}return e}},{key:"remote",value:function(t){if(console.log("[RulesInputSystem] id:".concat(this.id,", msg:").concat(JSON.stringify(t))),t.cmd===k.a.SubmitRule){var e=this.state.value.split("\n");(e=this.rulesCheck(e))?(this.setState((function(t){return{check:"OK"}})),console.log("[RulesInputSystem] ",e),v.getChannel("grid:1").put({cmd:k.a.PathRobot,rules:e})):this.setState((function(t){return{check:"Rule ERROR"}}))}}},{key:"render",value:function(){var t=this;return h.a.createElement("div",{className:"ruleInput"},h.a.createElement("p",null,"\u89c4\u5219"),h.a.createElement("div",null,h.a.createElement("textarea",{rows:"20",cols:"50",value:this.state.value,onChange:function(t){}})),h.a.createElement("div",{id:"start"},h.a.createElement("button",{onClick:function(){var e={cmd:k.a.SubmitRule};t.channel.put(e)}},"\u5f00\u59cb")),h.a.createElement("p",null,this.state.check))}}]),e}(g),T=function(t){function e(t){var n;Object(s.a)(this,e);(n=Object(r.a)(this,Object(c.a)(e).call(this,t))).grid=new G("grid:1");return n.ruleInput=new U("ruleInput:1"),n}return Object(u.a)(e,t),Object(a.a)(e,[{key:"render",value:function(){return h.a.createElement("div",{className:"room"},h.a.createElement(J,{entity:this.grid}),h.a.createElement("div",{id:"refresh"},h.a.createElement("button",{onClick:function(){var t={cmd:k.a.Refresh};v.getChannel("grid:1").put(t)}},"\u5237\u65b0")),h.a.createElement(A,{entity:this.ruleInput}))}}]),e}(l.Component);f.a.render(h.a.createElement(T,null),document.getElementById("root"))},3:function(t,e){t.exports={CanCross:"CanCross",SetRobot:"SetRobot",ClearRobot:"ClearRobot",Refresh:"Refresh",PathRobot:"PathRobot",SubmitRule:"SubmitRule"}}},[[10,1,2]]]);